<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps ¬∑ WTD Madagascar</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    #map {
      height: calc(100vh - 140px);
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .toolbar .action[disabled] {
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(20%);
    }
  </style>
</head>
<body>

<header>
  <a href="../index.html">‚Üê Menu</a>
  <div style="margin-top:6px;font-weight:800">
    üó∫Ô∏è Google Maps (r√©aliste) + Villes de Madagascar
  </div>
  <div class="muted" style="color:#dfefff">
    Internet requis. Carte Google Maps officielle.
  </div>
</header>

<main>
  <div class="card">
    <div class="toolbar">
      <button class="action" onclick="toggleCities()" id="btnCities" disabled>Afficher les villes</button>
      <button class="action" onclick="togglePoints()" id="btnPoints" disabled>Masquer les points WTD</button>
      <button class="action" onclick="fitAll()" id="btnFit" disabled>Zoom sur tout</button>
    </div>
    <p class="muted" style="margin-top:10px">
      ‚ö†Ô∏è Mets ta cl√© dans ce fichier : <code>TA_CLE_API</code> (ne colle jamais ta cl√© en public).
    </p>
  </div>

  <div class="card">
    <div id="map"></div>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>
</main>

<script type="module">
  import { load, parseGps, esc } from "../assets/js/app.js";

  const KEY_DB = "wtd_fokontany_db";

  let map = null;
  let info = null;

  let cityMarkers = [];
  let pointMarkers = [];

  let citiesVisible = false;
  let pointsVisible = true;

  const msgEl = document.getElementById("msg");
  const btnCities = document.getElementById("btnCities");
  const btnPoints = document.getElementById("btnPoints");
  const btnFit = document.getElementById("btnFit");

  const setMsg = (t) => { if (msgEl) msgEl.textContent = t || ""; };

  function setButtonsEnabled(enabled){
    for (const b of [btnCities, btnPoints, btnFit]){
      if (!b) continue;
      b.disabled = !enabled;
    }
  }

  function gmapLink(gps){
    const s = (gps || "").replace(/\s+/g, "").trim();
    if (!s.includes(",")) return "https://www.google.com/maps";
    return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(s);
  }

  function mkInfoPoint(p){
    return `
      <div style="max-width:280px">
        <div style="font-weight:800;margin-bottom:6px">${esc(p.nom || p.id || "Point")}</div>
        <div><b>ID:</b> ${esc(p.id || "")}</div>
        <div><b>R√©seau:</b> ${esc(p.reseau || "")}</div>
        <div><b>Statut:</b> ${esc(p.statut || "")}</div>
        <div style="margin-top:8px"><b>GPS:</b> ${esc(p.gps || "")}</div>
        <div style="margin-top:10px">
          <a target="_blank" rel="noopener" href="${gmapLink(p.gps || "")}">
            Ouvrir dans Google Maps
          </a>
        </div>
      </div>
    `;
  }

  function mkInfoCity(c){
    return `
      <div style="max-width:240px">
        <div style="font-weight:800;margin-bottom:6px">${esc(c.name)}</div>
        <div class="muted">Ville de Madagascar</div>
        <div style="margin-top:8px"><b>GPS:</b> ${c.lat}, ${c.lng}</div>
      </div>
    `;
  }

  async function loadCities(){
    try{
      const res = await fetch("../assets/data/villes-madagascar.json", { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const cities = Array.isArray(data?.cities) ? data.cities : [];
      // Nettoyage minimal
      return cities
        .filter(c => c && typeof c.name === "string" && Number.isFinite(c.lat) && Number.isFinite(c.lng))
        .map(c => ({ name: c.name, lat: Number(c.lat), lng: Number(c.lng) }));
    } catch (e){
      console.error("loadCities failed:", e);
      setMsg("Impossible de charger les villes (villes-madagascar.json). V√©rifie le chemin et le JSON.");
      return [];
    }
  }

  function clearMarkers(list){
    for (const m of list) m.setMap(null);
    list.length = 0;
  }

  function addPoints(){
    clearMarkers(pointMarkers);

    const pts = load(KEY_DB, [])
      .map(p => ({ ...p, ll: parseGps(p.gps) }))
      .filter(p => p.ll);

    for (const p of pts){
      const m = new google.maps.Marker({
        position: p.ll,
        map: pointsVisible ? map : null,
        title: p.nom || p.id || "Point"
      });
      m.addListener("click", () => {
        info.setContent(mkInfoPoint(p));
        info.open(map, m);
      });
      pointMarkers.push(m);
    }
  }

  async function addCities(){
    clearMarkers(cityMarkers);

    const cs = await loadCities();
    for (const c of cs){
      const m = new google.maps.Marker({
        position: { lat: c.lat, lng: c.lng },
        map: citiesVisible ? map : null,
        title: c.name
      });
      m.addListener("click", () => {
        info.setContent(mkInfoCity(c));
        info.open(map, m);
      });
      cityMarkers.push(m);
    }
  }

  function boundsAll(){
    const b = new google.maps.LatLngBounds();
    let count = 0;

    for (const m of pointMarkers){
      if (m.getMap()){
        b.extend(m.getPosition());
        count++;
      }
    }
    for (const m of cityMarkers){
      if (m.getMap()){
        b.extend(m.getPosition());
        count++;
      }
    }
    return count ? b : null;
  }

  // Fonctions globales appel√©es par les boutons
  window.toggleCities = async () => {
    if (!map) return;

    citiesVisible = !citiesVisible;
    btnCities.textContent = citiesVisible ? "Masquer les villes" : "Afficher les villes";

    if (!cityMarkers.length){
      await addCities();
    } else {
      for (const m of cityMarkers) m.setMap(citiesVisible ? map : null);
    }
  };

  window.togglePoints = () => {
    if (!map) return;

    pointsVisible = !pointsVisible;
    btnPoints.textContent = pointsVisible ? "Masquer les points WTD" : "Afficher les points WTD";

    for (const m of pointMarkers) m.setMap(pointsVisible ? map : null);
  };

  window.fitAll = () => {
    if (!map) return;

    const b = boundsAll();
    if (b) map.fitBounds(b);
    else setMsg("Aucun marqueur visible.");
  };

  // Callback Google Maps
  window.initMap = () => {
    if (!window.google || !google.maps){
      setMsg("Google Maps ne s‚Äôest pas charg√© (cl√©/API/billing/referrer). Ouvre F12 ‚Üí Console.");
      return;
    }

    const mapEl = document.getElementById("map");
    if (!mapEl){
      setMsg("Erreur: √©l√©ment #map introuvable.");
      return;
    }

    const center = { lat: -18.8792, lng: 47.5079 };

    map = new google.maps.Map(mapEl, {
      zoom: 6,
      center,
      mapTypeId: "roadmap",
      gestureHandling: "greedy"
    });

    info = new google.maps.InfoWindow();

    // Points WTD
    addPoints();

    setButtonsEnabled(true);
    setMsg("Clique ¬´ Afficher les villes ¬ª pour charger les villes.");

    // Auto-zoom sur points si pr√©sents
    if (pointMarkers.length){
      const b = new google.maps.LatLngBounds();
      for (const m of pointMarkers) b.extend(m.getPosition());
      map.fitBounds(b);
    }
  };

  // Message si Google Maps ne charge pas (cl√©/billing/referrer)
  setTimeout(() => {
    if (!window.google || !window.google.maps){
      setMsg("Google Maps ne s‚Äôest pas charg√©. V√©rifie : API activ√©e + facturation + referrer autoris√©.");
    }
  }, 4500);

  // Boutons d√©sactiv√©s au d√©but
  setButtonsEnabled(false);
</script>

<!-- ‚ö†Ô∏è Remplace TA_CLE_API par ta vraie cl√© (NE PAS publier ta cl√© en public) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=TA_CLE_API&callback=initMap"></script>

</body>
</html>
